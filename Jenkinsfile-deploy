pipeline{
   agent { node { label 'master' } }
   parameters {
       string(name: 'WF_PROCESS_INSTANCE_ID', defaultValue: '', description: 'Camunda Process Instance ID')
   } // End parameters
    stages {
        stage('Debug Info') {
            steps {
                script {
                    echo("Camunda Process Instance: $WF_PROCESS_INSTANCE_ID")
                    currentBuild.description =  "processInstanceId:${WF_PROCESS_INSTANCE_ID}"
                } // End script
            } // End steps
        } // End stage
        stage('Create RFC') {steps {script {echo("dummy stage")}}}
        stage ('Deploy Phase 1'){
            parallel {
                stage ('Keystores'){
                    steps {
                        script {
                            echo("dummy stage")
                            // throw new Exception("Simulate pipeline failure")
                        }
                    }
                }
                stage ('Aliases'){steps {script {echo("dummy stage");sleep(5)}}}
                stage ('Caches'){steps {script {echo("dummy stage")}}}
                stage ('Kvms'){steps {script {echo("dummy stage")}}}
                stage ('Shared Flow'){steps {script {echo("dummy stage")}}}
                stage ('Target Servers'){steps {script {echo("dummy stage")}}}
            } // end parallel
        } // end stage
        stage ('Deploy Phase 2'){
            parallel {
                stage ('References'){steps {script {echo("dummy stage")}}}
                stage ('Proxy'){steps {script {echo("dummy stage");sleep(5)}}}
            } // end parallel
        } // end stage
        stage ('Deploy Phase 3'){
            parallel {
                stage ('Developers'){steps {script {echo("dummy stage");sleep(5)}}}
                stage ('Flow Hooks'){steps {script {echo("dummy stage")}}}
                stage ('Products'){steps {script {echo("dummy stage")}}}
            } // end parallel
        } // end stage
        stage ('Deploy Phase 4'){
            parallel {
                stage ('Apps'){steps {script {echo("dummy stage");sleep(5)}}}
            } // end parallel
        } // end stage
    } // End stages
    post {
        // 'always' runs before 'success' or 'failure' or 'cleanup'
        always {
            script{
                def WORKFLOW_HOST = 'https://34.78.150.62:8443'
                def requestBody = """\
                                      {\"messageName\": \"deploymentComplete\",
                                      \"processInstanceId\": \"${WF_PROCESS_INSTANCE_ID}\",
                                      \"resultEnabled\": true}""".stripIndent()
                echo "Request:\n ${requestBody}"
                def response =  httpRequest authentication: 'jenkins-camunda',
                                httpMode: 'POST',
                                url: "${WORKFLOW_HOST}/engine-rest/message",
                                ignoreSslErrors: true,
                                contentType: "APPLICATION_JSON",
                                // requestBody: "{\"messageName\": \"deploymentComplete\",\"processInstanceId\": \"${WF_PROCESS_INSTANCE_ID}\" ,\"resultEnabled\": true}",
                                requestBody: "${requestBody}",
                                responseHandle: 'NONE',
                                validResponseCodes : '200,204',
                                consoleLogResponseBody: true
            }
        }
        failure {
            script {
                echo("Fail")
            } // End script
        } // End failure
        success {
            script {
                echo("Success")
            } // End script
        } // End success
        cleanup {
            script {
                currentBuild.displayName = "#${env.BUILD_NUMBER}"
                currentBuild.description =  "[DEPLOYMENT ${currentBuild.currentResult}] processInstanceId:${WF_PROCESS_INSTANCE_ID}"
                deleteDir()
            }
        }// Clean workspace
     } // End post
} // End pipeline
